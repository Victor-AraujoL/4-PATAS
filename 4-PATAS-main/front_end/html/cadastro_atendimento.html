<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Associa칞칚o 4 Patas - Cadastro de Atendimento</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <link rel="stylesheet" type="text/css" href="../css/cadastro_atendimento.css"/>

</head>
<body>
    <!-- Decorative paws -->
    <div class="paws paw1">游</div>
    <div class="paws paw2">游</div>
    <div class="paws paw3">游</div>

    <!-- Header -->
    <header class="main-header">
        <div class="main-container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">
                        <i class="fas fa-paw"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Cadastro de Atendimento</h1>
                        <p class="header-subtitle">Associa칞칚o 4 Patas</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-custom-secondary" onclick="window.location.href='index.html';">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Menu
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Alert -->
        <div id="alert" class="alert d-none mt-3" role="alert"></div>

        <!-- Formul치rio de Cadastro -->
        <div class="content-card">
            <div class="card-header-custom">
                <h3>
                    <i class="fas fa-user-md"></i>
                    Novo Atendimento Veterin치rio
                </h3>
            </div>
            <div class="card-body-custom">
                <form id="form-atendimento" novalidate>
                    <!-- Primeira linha: Pet e Colaborador -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label for="pet" class="form-label form-label-custom required">Pet</label>
                            <select id="pet" name="idPet" class="form-control form-control-custom" required>
                                <option value="">Selecione o Pet</option>
                            </select>
                            <div class="invalid-feedback">Por favor, selecione um pet.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="colaborador" class="form-label form-label-custom required">Veterin치rio</label>
                            <select id="colaborador" name="idColaborador" class="form-control form-control-custom" required>
                                <option value="">Selecione o Veterin치rio</option>
                            </select>
                            <div class="invalid-feedback">Por favor, selecione um veterin치rio.</div>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Respons치vel e Peso -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label for="usuario" class="form-label form-label-custom required">Respons치vel</label>
                            <input type="text" id="usuario" name="responsavel" class="form-control form-control-custom"
                                   placeholder="Digite o nome do respons치vel" required>
                            <div class="invalid-feedback">Por favor, informe o respons치vel.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="peso" class="form-label form-label-custom required">Peso (kg)</label>
                            <input type="number" id="peso" name="peso" class="form-control form-control-custom" 
                                   step="0.01" min="0" placeholder="Ex: 12.5" required>
                            <div class="invalid-feedback">Por favor, informe o peso do animal.</div>
                        </div>
                    </div>
                    
                    <!-- Terceira linha: Data/Hora e Medicamento -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label for="dataHora" class="form-label form-label-custom required">Data e Hora</label>
                            <input type="datetime-local" id="dataHora" name="dataHora" class="form-control form-control-custom" required>
                            <div class="invalid-feedback">Por favor, selecione uma data e hora.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="medicamento" class="form-label form-label-custom">Medicamento</label>
                            <input type="text" id="medicamento" name="medicamento" class="form-control form-control-custom" 
                                   placeholder="Ex: Antibi칩tico, Verm칤fugo...">
                        </div>
                    </div>
                    
                    <!-- Diagn칩stico -->
                    <div class="mb-3">
                        <label for="diagnostico" class="form-label form-label-custom required">Diagn칩stico</label>
                        <textarea id="diagnostico" name="diagnostico" class="form-control form-control-custom" 
                                  rows="4" placeholder="Descreva o diagn칩stico detalhado..." required></textarea>
                        <div class="invalid-feedback">Por favor, informe o diagn칩stico.</div>
                    </div>
                    
                    <!-- Observa칞칫es -->
                    <div class="mb-4">
                        <label for="observacao" class="form-label form-label-custom">Observa칞칫es</label>
                        <textarea id="observacao" name="observacao" class="form-control form-control-custom" 
                                  rows="3" placeholder="Observa칞칫es adicionais (opcional)..."></textarea>
                    </div>
                    
                    <!-- Bot칫es de A칞칚o -->
                    <div class="d-flex flex-column flex-md-row justify-content-end gap-2">
                        <button type="button" id="btn-cancelar" class="btn btn-clear">
                            <i class="fas fa-eraser me-2"></i>
                            Limpar Formul치rio
                        </button>
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-save me-2"></i>
                            Salvar Atendimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma칞칚o -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar A칞칚o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-question-circle text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p id="modal-message">Tem certeza que deseja realizar esta a칞칚o?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-action">
                        <i class="fas fa-check me-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API URLs - Detecta automaticamente a origem
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : `${window.location.origin}/api`;
        const API_PETS_URL = `${API_BASE_URL}/pets`;
        const API_COLABORADORES_URL = `${API_BASE_URL}/colaboradores`;
        const API_ATENDIMENTOS_URL = `${API_BASE_URL}/atendimentos`;

        // Arrays para armazenar dados carregados da API
        let pets = [];
        let colaboradores = [];
        let editingAtendimentoId = null; // ID do atendimento em edi칞칚o

        // Elementos DOM
        const alertBox = document.getElementById('alert');
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        let pendingAction = null;

        // Mostrar alerta
        function showAlert(message, type) {
            alertBox.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
                ${message}
            `;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('d-none');
            
            setTimeout(() => {
                alertBox.classList.add('d-none');
            }, 4000);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Fun칞칚o para carregar pets da API
        async function carregarPets() {
            try {
                const response = await fetch(API_PETS_URL);
                if (response.ok) {
                    pets = await response.json();
                    const selectPet = document.getElementById('pet');

                    pets.forEach(pet => {
                        const option = document.createElement('option');
                        option.value = pet.IDPET;
                        option.textContent = `${pet.NOME} (${pet.ESPECIE || 'N/A'}${pet.RACA ? ' - ' + pet.RACA : ''})`;
                        selectPet.appendChild(option);
                    });
                } else {
                    showAlert('Erro ao carregar lista de pets', 'danger');
                }
            } catch (error) {
                console.error('Erro ao carregar pets:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est치 rodando.', 'danger');
            }
        }

        // Fun칞칚o para carregar colaboradores da API
        async function carregarColaboradores() {
            try {
                const response = await fetch(API_COLABORADORES_URL);
                if (response.ok) {
                    colaboradores = await response.json();
                    const selectColaborador = document.getElementById('colaborador');

                    colaboradores.forEach(colaborador => {
                        const option = document.createElement('option');
                        option.value = colaborador.IDCOLABORADOR;
                        option.textContent = `${colaborador.NOME}${colaborador.CARGO ? ' (' + colaborador.CARGO + ')' : ''}`;
                        selectColaborador.appendChild(option);
                    });
                } else {
                    showAlert('Erro ao carregar lista de veterin치rios', 'danger');
                }
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est치 rodando.', 'danger');
            }
        }

        // Fun칞칚o para carregar todos os selects
        async function carregarSelects() {
            await Promise.all([
                carregarPets(),
                carregarColaboradores()
            ]);
        }
        
        // Fun칞칚o para definir a data e hora atual como valor padr칚o
        function definirDataHoraAtual() {
            const dataHoraInput = document.getElementById('dataHora');
            const agora = new Date();
            
            // Formatar a data para o formato esperado pelo input datetime-local
            const ano = agora.getFullYear();
            const mes = String(agora.getMonth() + 1).padStart(2, '0');
            const dia = String(agora.getDate()).padStart(2, '0');
            const hora = String(agora.getHours()).padStart(2, '0');
            const minuto = String(agora.getMinutes()).padStart(2, '0');
            
            const dataFormatada = `${ano}-${mes}-${dia}T${hora}:${minuto}`;
            dataHoraInput.value = dataFormatada;
        }
        
        // Fun칞칚o para carregar dados do atendimento para edi칞칚o
        async function loadAtendimentoData(atendimentoId) {
            try {
                const response = await fetch(`${API_ATENDIMENTOS_URL}/${atendimentoId}`);
                if (response.ok) {
                    const result = await response.json();
                    const atendimento = result.data || result;

                    // Atualizar t칤tulo
                    document.querySelector('.card-header-custom h3').innerHTML = '<i class="fas fa-edit"></i> Editar Atendimento';
                    const submitBtn = document.querySelector('#form-atendimento button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Atualizar Atendimento';

                    // Preencher formul치rio
                    document.getElementById('pet').value = atendimento.IDPET || '';
                    document.getElementById('colaborador').value = atendimento.IDCOLABORADOR || '';
                    document.getElementById('usuario').value = atendimento.RESPONSAVEL || '';
                    document.getElementById('peso').value = atendimento.PESO || '';
                    document.getElementById('medicamento').value = atendimento.MEDICAMENTO || '';
                    document.getElementById('diagnostico').value = atendimento.DIAGNOSTICO || '';
                    document.getElementById('observacao').value = atendimento.OBSERVACAO || '';

                    // Formatar data e hora para o input datetime-local
                    if (atendimento.DATAHORA) {
                        const dataHora = new Date(atendimento.DATAHORA);
                        const ano = dataHora.getFullYear();
                        const mes = String(dataHora.getMonth() + 1).padStart(2, '0');
                        const dia = String(dataHora.getDate()).padStart(2, '0');
                        const hora = String(dataHora.getHours()).padStart(2, '0');
                        const minuto = String(dataHora.getMinutes()).padStart(2, '0');
                        document.getElementById('dataHora').value = `${ano}-${mes}-${dia}T${hora}:${minuto}`;
                    }

                } else {
                    showAlert('Erro ao carregar dados do atendimento', 'danger');
                    setTimeout(() => {
                        window.location.href = 'historico_atendimento_admin.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor', 'danger');
                setTimeout(() => {
                    window.location.href = 'historico_atendimento_admin.html';
                }, 2000);
            }
        }

        // Fun칞칚o para validar o formul치rio
        function validarFormulario(form) {
            let formValido = true;

            // Limpar valida칞칫es anteriores
            form.querySelectorAll('.is-invalid').forEach(campo => {
                campo.classList.remove('is-invalid');
            });

            // Verificar campos obrigat칩rios
            form.querySelectorAll('[required]').forEach(campo => {
                if (!campo.value.trim()) {
                    campo.classList.add('is-invalid');
                    formValido = false;
                } else {
                    campo.classList.remove('is-invalid');
                }
            });

            // Valida칞칚o espec칤fica para o campo de peso
            const pesoInput = form.querySelector('#peso');
            if (pesoInput.value && parseFloat(pesoInput.value) <= 0) {
                pesoInput.classList.add('is-invalid');
                const feedback = pesoInput.nextElementSibling;
                feedback.textContent = "O peso deve ser maior que zero.";
                formValido = false;
            }

            return formValido;
        }
        
        // Fun칞칚o para salvar o atendimento
        async function salvarAtendimento(form) {
            // Mostrar loading
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            const isEditing = editingAtendimentoId !== null;

            submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${isEditing ? 'Atualizando...' : 'Salvando...'}`;
            submitBtn.disabled = true;

            // Coletar os dados do formul치rio
            const formData = new FormData(form);

            // Preparar dados para o backend
            const atendimento = {
                IDPET: parseInt(formData.get('idPet')),
                IDCOLABORADOR: parseInt(formData.get('idColaborador')),
                RESPONSAVEL: formData.get('responsavel'),
                PESO: parseFloat(formData.get('peso')),
                DATAHORA: formData.get('dataHora'),
                MEDICAMENTO: formData.get('medicamento') || null,
                DIAGNOSTICO: formData.get('diagnostico'),
                OBSERVACAO: formData.get('observacao') || null
            };

            // Apenas adicionar DATACAD se for um novo cadastro
            if (!isEditing) {
                atendimento.DATACAD = new Date().toISOString();
            }

            try {
                const url = isEditing
                    ? `${API_ATENDIMENTOS_URL}/${editingAtendimentoId}`
                    : API_ATENDIMENTOS_URL;

                const response = await fetch(url, {
                    method: isEditing ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(atendimento)
                });

                const result = await response.json();

                if (response.ok) {
                    const message = isEditing
                        ? 'Atendimento atualizado com sucesso!'
                        : 'Atendimento cadastrado com sucesso!';

                    showAlert(message, 'success');

                    // Redirecionar para hist칩rico ap칩s sucesso
                    setTimeout(() => {
                        window.location.href = 'historico_atendimento_admin.html';
                    }, 1500);
                } else {
                    showAlert(result.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} atendimento`, 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est치 rodando.', 'danger');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Fun칞칚o para confirmar a칞칚o
        function confirmarAcao(message, callback) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('btn-confirm-action').onclick = () => {
                confirmModal.hide();
                callback();
            };
            confirmModal.show();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se est치 editando um atendimento (par칙metro id na URL)
            const urlParams = new URLSearchParams(window.location.search);
            const atendimentoId = urlParams.get('id');

            carregarSelects();

            if (atendimentoId) {
                editingAtendimentoId = atendimentoId;
                // Aguardar os selects carregarem antes de preencher os dados
                setTimeout(() => {
                    loadAtendimentoData(atendimentoId);
                }, 500);
            } else {
                definirDataHoraAtual();
            }

            const form = document.getElementById('form-atendimento');
            
            // Listener para o evento de submit do formul치rio
            form.addEventListener('submit', event => {
                event.preventDefault();
                
                if (validarFormulario(form)) {
                    confirmarAcao('Tem certeza que deseja salvar este atendimento?', () => {
                        salvarAtendimento(form);
                    });
                } else {
                    showAlert('Por favor, corrija os campos destacados em vermelho.', 'danger');
                }
            });
            
            // Listener para o bot칚o de limpar formul치rio
            document.getElementById('btn-cancelar').addEventListener('click', () => {
                confirmarAcao('Tem certeza que deseja limpar todos os campos do formul치rio?', () => {
                    form.reset();
                    definirDataHoraAtual();
                    // Remover classes de valida칞칚o
                    form.querySelectorAll('.is-invalid').forEach(campo => {
                        campo.classList.remove('is-invalid');
                    });
                    showAlert('Formul치rio limpo com sucesso!', 'success');
                });
            });
            
            // Valida칞칚o em tempo real ao sair do campo
            form.querySelectorAll('input, select, textarea').forEach(campo => {
                campo.addEventListener('blur', () => {
                    if (campo.hasAttribute('required') && !campo.value.trim()) {
                        campo.classList.add('is-invalid');
                    } else {
                        campo.classList.remove('is-invalid');
                    }
                });
                
                // Remover valida칞칚o ao digitar
                campo.addEventListener('input', () => {
                    if (campo.classList.contains('is-invalid') && campo.value.trim()) {
                        campo.classList.remove('is-invalid');
                    }
                });
            });
            
            // Valida칞칚o espec칤fica para o campo de peso
            const pesoInput = document.getElementById('peso');
            pesoInput.addEventListener('blur', () => {
                if (pesoInput.value && parseFloat(pesoInput.value) <= 0) {
                    pesoInput.classList.add('is-invalid');
                    const feedback = pesoInput.nextElementSibling;
                    feedback.textContent = "O peso deve ser maior que zero.";
                }
            });
        });
    </script>
</body>
</html>
