<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Associa√ß√£o 4 Patas - Cadastro de Pet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <link rel="stylesheet" type="text/css" href="../css/cadastro_pet.css"/>
    
</head>
<body>
    <!-- Decorative paws -->
    <div class="paws paw1">üêæ</div>
    <div class="paws paw2">üêæ</div>
    <div class="paws paw3">üêæ</div>

    <!-- Header -->
    <header class="main-header">
        <div class="main-container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">
                        <i class="fas fa-paw"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Cadastro de Pet</h1>
                        <p class="header-subtitle">Associa√ß√£o 4 Patas</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-custom-secondary" onclick="window.location.href='pets.html';">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar √† Lista
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Alert -->
        <div id="alert" class="alert d-none mt-3" role="alert"></div>

        <!-- Formul√°rio de Cadastro -->
        <div class="content-card">
            <div class="card-header-custom">
                <h3>
                    <i class="fas fa-plus-circle"></i>
                    Novo Pet na Associa√ß√£o
                </h3>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <div class="step-indicator">
                    <div class="step active" id="step-1">1</div>
                    <div class="step-line" id="line-1"></div>
                    <div class="step" id="step-2">2</div>
                </div>
                <div class="step-text" id="step-text">Dados do Pet</div>
            </div>

            <div class="card-body-custom">
                <form id="petForm" novalidate>
                    <!-- STEP 1: Dados do Pet -->
                    <div class="form-step active" id="form-step-1">
                        <h5 class="mb-4 text-primary-custom">
                            <i class="fas fa-paw me-2"></i>
                            Informa√ß√µes do Pet
                        </h5>

                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="pet-name" class="form-label form-label-custom required">Nome do Pet</label>
                                <input type="text" id="pet-name" name="petName" class="form-control form-control-custom" 
                                       placeholder="Digite o nome do pet" required>
                                <div class="invalid-feedback">Nome √© obrigat√≥rio</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="pet-species" class="form-label form-label-custom required">Esp√©cie</label>
                                <select id="pet-species" name="petSpecies" class="form-control form-control-custom" required>
                                    <option value="">Selecione a esp√©cie</option>
                                    <option value="cachorro">Cachorro</option>
                                    <option value="gato">Gato</option>
                                    <option value="ave">Ave</option>
                                    <option value="reptil">R√©ptil</option>
                                    <option value="roedor">Roedor</option>
                                    <option value="outro">Outro</option>
                                </select>
                                <div class="invalid-feedback">Esp√©cie √© obrigat√≥ria</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="pet-breed" class="form-label form-label-custom">Ra√ßa</label>
                                <input type="text" id="pet-breed" name="petBreed" class="form-control form-control-custom" 
                                       placeholder="Ex: Labrador, SRD, Siam√™s...">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="pet-age" class="form-label form-label-custom">Idade (meses)</label>
                                <input type="number" id="pet-age" name="petAge" class="form-control form-control-custom" 
                                       placeholder="Ex: 24" min="0">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="pet-weight" class="form-label form-label-custom">Peso (kg)</label>
                                <input type="number" id="pet-weight" name="petWeight" class="form-control form-control-custom" 
                                       placeholder="Ex: 12.5" step="0.1" min="0">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="pet-color" class="form-label form-label-custom">Cor</label>
                                <input type="text" id="pet-color" name="petColor" class="form-control form-control-custom" 
                                       placeholder="Ex: Caramelo, Preto, Branco...">
                            </div>
                        </div>

                        <!-- Sexo -->
                        <div class="mb-3">
                            <label class="form-label form-label-custom">Sexo</label>
                            <div class="radio-group">
                                <label class="radio-option selected" for="male">
                                    <input type="radio" name="petGender" id="male" value="M" checked>
                                    Macho
                                </label>
                                <label class="radio-option" for="female">
                                    <input type="radio" name="petGender" id="female" value="F">
                                    F√™mea
                                </label>
                            </div>
                        </div>

                        <!-- Castrado -->
                        <div class="mb-3">
                            <label class="form-label form-label-custom">Castrado</label>
                            <div class="radio-group">
                                <label class="radio-option" for="castrated-yes">
                                    <input type="radio" name="petCastrated" id="castrated-yes" value="S">
                                    Sim
                                </label>
                                <label class="radio-option selected" for="castrated-no">
                                    <input type="radio" name="petCastrated" id="castrated-no" value="N" checked>
                                    N√£o
                                </label>
                            </div>
                        </div>

                        <!-- Status de Ado√ß√£o -->
                        <div class="mb-3">
                            <label for="pet-status" class="form-label form-label-custom required">Status de Ado√ß√£o</label>
                            <select id="pet-status" name="petStatus" class="form-control form-control-custom" required>
                                <option value="">Selecione o status</option>
                                <option value="D">Dispon√≠vel para Ado√ß√£o</option>
                                <option value="A">Adotado</option>
                                <option value="T">Em Tratamento</option>
                            </select>
                            <div class="invalid-feedback">Status √© obrigat√≥rio</div>
                        </div>

                        <!-- Caracter√≠sticas -->
                        <div class="mb-4">
                            <label for="pet-characteristics" class="form-label form-label-custom">Caracter√≠sticas</label>
                            <textarea id="pet-characteristics" name="petCharacteristics" class="form-control form-control-custom" 
                                      rows="3" placeholder="Descreva o comportamento, personalidade, cuidados especiais..."></textarea>
                        </div>

                        <!-- Op√ß√£o sem tutor -->
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="no-tutor" name="noTutor">
                                <span class="slider"></span>
                            </label>
                            <div>
                                <div class="toggle-label">Pet sem tutor (resgate/abandono)</div>
                                <small class="text-muted">Marque se o pet n√£o possui tutor cadastrado</small>
                            </div>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                            <div></div>
                            <button type="button" class="btn btn-next" onclick="nextStep()">
                                Pr√≥ximo
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Dados do Tutor -->
                    <div class="form-step" id="form-step-2">
                        <h5 class="mb-4 text-primary-custom">
                            <i class="fas fa-user me-2"></i>
                            Dados do Tutor
                        </h5>

                        <!-- Dados Pessoais -->
                        <div class="row mb-3">
                            <div class="col-md-8 mb-3">
                                <label for="tutor-name" class="form-label form-label-custom required">Nome Completo</label>
                                <input type="text" id="tutor-name" name="tutorName" class="form-control form-control-custom" 
                                       placeholder="Nome completo do tutor" required>
                                <div class="invalid-feedback">Nome √© obrigat√≥rio</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="tutor-cpf" class="form-label form-label-custom required">CPF</label>
                                <input type="text" id="tutor-cpf" name="tutorCpf" class="form-control form-control-custom" 
                                       placeholder="000.000.000-00" required>
                                <div class="invalid-feedback">CPF √© obrigat√≥rio</div>
                            </div>
                        </div>

                        <!-- Contato -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="tutor-phone" class="form-label form-label-custom required">Telefone</label>
                                <input type="tel" id="tutor-phone" name="tutorPhone" class="form-control form-control-custom" 
                                       placeholder="(00) 00000-0000" required>
                                <div class="invalid-feedback">Telefone √© obrigat√≥rio</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="tutor-email" class="form-label form-label-custom">E-mail</label>
                                <input type="email" id="tutor-email" name="tutorEmail" class="form-control form-control-custom" 
                                       placeholder="email@exemplo.com">
                            </div>
                        </div>

                        <!-- Endere√ßo -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-3">
                                <label for="tutor-cep" class="form-label form-label-custom required">CEP</label>
                                <div class="input-group">
                                    <input type="text" id="tutor-cep" name="tutorCep" class="form-control form-control-custom"
                                           placeholder="00000-000" required>
                                    <button class="btn btn-outline-secondary" type="button" id="btn-buscar-cep" title="Buscar CEP">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">CEP √© obrigat√≥rio</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="tutor-address" class="form-label form-label-custom required">Endere√ßo</label>
                                <input type="text" id="tutor-address" name="tutorAddress" class="form-control form-control-custom"
                                       placeholder="Rua, Avenida..." required>
                                <div class="invalid-feedback">Endere√ßo √© obrigat√≥rio</div>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="tutor-number" class="form-label form-label-custom required">N√∫mero</label>
                                <input type="text" id="tutor-number" name="tutorNumber" class="form-control form-control-custom"
                                       placeholder="N¬∫" required>
                                <div class="invalid-feedback">N√∫mero √© obrigat√≥rio</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4 mb-3">
                                <label for="tutor-bairro" class="form-label form-label-custom">Bairro</label>
                                <input type="text" id="tutor-bairro" name="tutorBairro" class="form-control form-control-custom"
                                       placeholder="Bairro">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="tutor-city" class="form-label form-label-custom required">Cidade</label>
                                <input type="text" id="tutor-city" name="tutorCity" class="form-control form-control-custom"
                                       placeholder="Cidade" required>
                                <div class="invalid-feedback">Cidade √© obrigat√≥ria</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="tutor-state" class="form-label form-label-custom required">Estado</label>
                                <select id="tutor-state" name="tutorState" class="form-control form-control-custom" required>
                                    <option value="">Selecione o estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                                <div class="invalid-feedback">Estado √© obrigat√≥rio</div>
                            </div>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                            <button type="button" class="btn btn-clear" onclick="previousStep()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Voltar
                            </button>
                            <div class="d-flex flex-column flex-md-row gap-2">
                                <button type="button" class="btn btn-clear" onclick="resetForm()">
                                    <i class="fas fa-eraser me-2"></i>
                                    Limpar Formul√°rio
                                </button>
                                <button type="submit" class="btn btn-save" id="submit-btn">
                                    <i class="fas fa-save me-2"></i>
                                    Cadastrar Pet
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar A√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-question-circle text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p id="modal-message">Tem certeza que deseja realizar esta a√ß√£o?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-action">
                        <i class="fas fa-check me-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentStep = 1;
        let editingPetId = null; // ID do pet em edi√ß√£o

        // Elementos DOM
        const alertBox = document.getElementById('alert');
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        // API URL - Detecta automaticamente a origem
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : `${window.location.origin}/api`;
        const API_URL = `${API_BASE}/pets`;

        // Mostrar alerta
        function showAlert(message, type) {
            alertBox.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
                ${message}
            `;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('d-none');
            
            setTimeout(() => {
                alertBox.classList.add('d-none');
            }, 4000);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Atualizar indicador de passos
        function updateStep() {
            // Remover classes ativas
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById(`form-step-${currentStep}`).classList.add('active');
            
            if (currentStep === 1) {
                document.getElementById('step-1').classList.add('active');
                document.getElementById('step-1').classList.remove('completed');
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('line-1').classList.remove('completed');
                document.getElementById('step-text').textContent = 'Dados do Pet';
            } else {
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-1').classList.add('completed');
                document.getElementById('step-2').classList.add('active');
                document.getElementById('line-1').classList.add('completed');
                document.getElementById('step-text').textContent = 'Dados do Tutor';
            }
        }

        // Pr√≥ximo passo
        function nextStep() {
            if (validateStep1()) {
                // Verificar se √© "sem tutor"
                const noTutor = document.getElementById('no-tutor').checked;
                if (noTutor) {
                    // Pular para submiss√£o direta
                    confirmarAcao('Pet sem tutor cadastrado. Deseja finalizar o cadastro?', () => {
                        submitForm(true);
                    });
                } else {
                    currentStep = 2;
                    updateStep();
                    showAlert('Pr√≥xima etapa: dados do tutor', 'success');
                }
            }
        }

        // Passo anterior
        function previousStep() {
            currentStep = 1;
            updateStep();
        }

        // Validar primeiro passo
        function validateStep1() {
            const name = document.getElementById('pet-name');
            const species = document.getElementById('pet-species');
            const status = document.getElementById('pet-status');
            let isValid = true;

            // Limpar valida√ß√µes anteriores
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });

            if (!name.value.trim()) {
                name.classList.add('is-invalid');
                isValid = false;
            }

            if (!species.value) {
                species.classList.add('is-invalid');
                isValid = false;
            }

            if (!status.value) {
                status.classList.add('is-invalid');
                isValid = false;
            }

            if (!isValid) {
                showAlert('Por favor, preencha todos os campos obrigat√≥rios.', 'danger');
            }

            return isValid;
        }

        // Validar segundo passo
        function validateStep2() {
            const requiredFields = [
                'tutor-name', 'tutor-cpf', 'tutor-phone', 'tutor-cep',
                'tutor-address', 'tutor-number', 'tutor-city', 'tutor-state'
            ];

            let isValid = true;

            // Limpar valida√ß√µes anteriores
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });

            if (!isValid) {
                showAlert('Por favor, preencha todos os campos obrigat√≥rios do tutor.', 'danger');
            }

            return isValid;
        }

        // Carregar dados do pet para edi√ß√£o
        async function loadPetData(petId) {
            try {
                const response = await fetch(`${API_URL}/${petId}`);
                if (response.ok) {
                    const pet = await response.json();

                    // Atualizar t√≠tulo
                    document.querySelector('.card-header-custom h3').innerHTML = '<i class="fas fa-edit"></i> Editar Pet';
                    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save me-2"></i>Atualizar Pet';

                    // Preencher dados do pet
                    document.getElementById('pet-name').value = pet.NOME || '';
                    document.getElementById('pet-species').value = pet.ESPECIE || '';
                    document.getElementById('pet-breed').value = pet.RACA || '';
                    document.getElementById('pet-age').value = pet.IDADE || '';
                    document.getElementById('pet-weight').value = pet.PESO || '';
                    document.getElementById('pet-color').value = pet.COR || '';
                    document.getElementById('pet-status').value = pet.SITUACAO_ADOCAO || '';
                    document.getElementById('pet-characteristics').value = pet.CARACTERISTICAS || '';

                    // Sexo
                    if (pet.SEXO) {
                        const sexoRadio = document.querySelector(`input[name="petGender"][value="${pet.SEXO}"]`);
                        if (sexoRadio) {
                            sexoRadio.checked = true;
                            document.querySelectorAll('input[name="petGender"]').forEach(r => {
                                r.parentElement.classList.remove('selected');
                            });
                            sexoRadio.parentElement.classList.add('selected');
                        }
                    }

                    // Castrado
                    if (pet.CASTRADO) {
                        const castradoRadio = document.querySelector(`input[name="petCastrated"][value="${pet.CASTRADO}"]`);
                        if (castradoRadio) {
                            castradoRadio.checked = true;
                            document.querySelectorAll('input[name="petCastrated"]').forEach(r => {
                                r.parentElement.classList.remove('selected');
                            });
                            castradoRadio.parentElement.classList.add('selected');
                        }
                    }

                    // Preencher dados do tutor se existirem
                    if (pet.RESPONSAVEL) {
                        document.getElementById('tutor-name').value = pet.RESPONSAVEL || '';
                        document.getElementById('tutor-phone').value = pet.TELEFONE || '';
                        document.getElementById('tutor-address').value = pet.LOGRADOURO || '';
                        document.getElementById('tutor-number').value = pet.NUMERO || '';
                        document.getElementById('tutor-bairro').value = pet.BAIRRO || '';
                        document.getElementById('tutor-city').value = pet.CIDADE || '';
                        document.getElementById('tutor-state').value = pet.ESTADO || '';
                        document.getElementById('no-tutor').checked = false;
                    } else {
                        document.getElementById('no-tutor').checked = true;
                    }

                } else {
                    showAlert('Erro ao carregar dados do pet', 'danger');
                    setTimeout(() => {
                        window.location.href = 'pets.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor', 'danger');
                setTimeout(() => {
                    window.location.href = 'pets.html';
                }, 2000);
            }
        }

        // Submeter formul√°rio
        async function submitForm(noTutor = false) {
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            const isEditing = editingPetId !== null;

            submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${isEditing ? 'Atualizando...' : 'Cadastrando...'}`;
            submitBtn.disabled = true;

            // Coletar dados do formul√°rio
            const petData = {
                NOME: document.getElementById('pet-name').value,
                ESPECIE: document.getElementById('pet-species').value,
                RACA: document.getElementById('pet-breed').value || null,
                IDADE: document.getElementById('pet-age').value || null,
                PESO: document.getElementById('pet-weight').value || null,
                COR: document.getElementById('pet-color').value || null,
                SEXO: document.querySelector('input[name="petGender"]:checked').value,
                CASTRADO: document.querySelector('input[name="petCastrated"]:checked').value,
                SITUACAO_ADOCAO: document.getElementById('pet-status').value,
                CARACTERISTICAS: document.getElementById('pet-characteristics').value || null,
                ATIVO: 'S'
            };

            // Apenas adicionar DATACAD se for um novo cadastro
            if (!isEditing) {
                petData.DATACAD = new Date().toISOString();
            }

            // Se n√£o for "sem tutor", adicionar dados do tutor
            if (!noTutor) {
                petData.RESPONSAVEL = document.getElementById('tutor-name').value;
                petData.TELEFONE = document.getElementById('tutor-phone').value;
                petData.LOGRADOURO = document.getElementById('tutor-address').value;
                petData.NUMERO = document.getElementById('tutor-number').value;
                petData.BAIRRO = document.getElementById('tutor-bairro').value || null;
                petData.CIDADE = document.getElementById('tutor-city').value;
                petData.ESTADO = document.getElementById('tutor-state').value;
            } else {
                // Se for "sem tutor", enviar null para limpar os dados do tutor
                petData.RESPONSAVEL = null;
                petData.TELEFONE = null;
                petData.LOGRADOURO = null;
                petData.NUMERO = null;
                petData.BAIRRO = null;
                petData.CIDADE = null;
                petData.ESTADO = null;
            }

            try {
                const url = isEditing
                    ? `${API_URL}/${editingPetId}`
                    : API_URL;

                const response = await fetch(url, {
                    method: isEditing ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(petData)
                });

                const result = await response.json();

                if (response.ok) {
                    const message = isEditing
                        ? 'Pet atualizado com sucesso!'
                        : (noTutor ? 'Pet sem tutor cadastrado com sucesso!' : 'Pet cadastrado com sucesso!');

                    showAlert(message, 'success');

                    // Redirecionar para lista ap√≥s sucesso
                    setTimeout(() => {
                        window.location.href = 'pets.html';
                    }, 1500);
                } else {
                    showAlert(result.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} pet`, 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est√° rodando.', 'danger');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Confirmar a√ß√£o
        function confirmarAcao(message, callback) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('btn-confirm-action').onclick = () => {
                confirmModal.hide();
                callback();
            };
            confirmModal.show();
        }

        // Limpar formul√°rio
        function resetForm() {
            confirmarAcao('Tem certeza que deseja limpar todos os campos?', () => {
                document.getElementById('petForm').reset();
                
                // Resetar valida√ß√µes
                document.querySelectorAll('.is-invalid').forEach(field => {
                    field.classList.remove('is-invalid');
                });
                
                // Resetar radio buttons
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.querySelector('input[name="petGender"][value="M"]').parentElement.classList.add('selected');
                document.querySelector('input[name="petCastrated"][value="N"]').parentElement.classList.add('selected');
                
                // Voltar ao primeiro passo
                currentStep = 1;
                updateStep();
                
                showAlert('Formul√°rio limpo com sucesso!', 'success');
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se est√° editando um pet (par√¢metro id na URL)
            const urlParams = new URLSearchParams(window.location.search);
            const petId = urlParams.get('id');

            if (petId) {
                editingPetId = petId;
                loadPetData(petId);
            }

            // Radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const name = this.name;
                    document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                        r.parentElement.classList.remove('selected');
                    });
                    this.parentElement.classList.add('selected');
                });
            });

            // Toggle sem tutor
            document.getElementById('no-tutor').addEventListener('change', function() {
                if (this.checked) {
                    showAlert('Pet marcado como "sem tutor". Voc√™ poder√° finalizar diretamente.', 'warning');
                    // Limpar campos do tutor quando marcar "sem tutor"
                    document.getElementById('tutor-name').value = '';
                    document.getElementById('tutor-cpf').value = '';
                    document.getElementById('tutor-phone').value = '';
                    document.getElementById('tutor-email').value = '';
                    document.getElementById('tutor-cep').value = '';
                    document.getElementById('tutor-address').value = '';
                    document.getElementById('tutor-number').value = '';
                    document.getElementById('tutor-bairro').value = '';
                    document.getElementById('tutor-city').value = '';
                    document.getElementById('tutor-state').value = '';

                    // Remover valida√ß√µes
                    document.querySelectorAll('#form-step-2 .is-invalid').forEach(field => {
                        field.classList.remove('is-invalid');
                    });
                }
            });

            // M√°scaras
            document.getElementById('tutor-phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 10) {
                    value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
                } else {
                    value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
                }
                e.target.value = value;
            });

            document.getElementById('tutor-cpf').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, '$1.$2.$3-$4');
                e.target.value = value;
            });

            document.getElementById('tutor-cep').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/^(\d{5})(\d{0,3}).*/, '$1-$2');
                e.target.value = value;
            });

            // Fun√ß√£o para buscar CEP
            async function buscarCEP() {
                const cepInput = document.getElementById('tutor-cep');
                const cep = cepInput.value.replace(/\D/g, '');

                if (cep.length !== 8) {
                    showAlert('CEP inv√°lido. Digite 8 d√≠gitos.', 'warning');
                    return;
                }

                const btnBuscarCep = document.getElementById('btn-buscar-cep');
                const originalBtnText = btnBuscarCep.innerHTML;
                btnBuscarCep.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btnBuscarCep.disabled = true;

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();

                    if (data.erro) {
                        showAlert('CEP n√£o encontrado.', 'warning');
                    } else {
                        document.getElementById('tutor-address').value = data.logradouro || '';
                        document.getElementById('tutor-bairro').value = data.bairro || '';
                        document.getElementById('tutor-city').value = data.localidade || '';
                        document.getElementById('tutor-state').value = data.uf || '';

                        // Focar no campo n√∫mero
                        document.getElementById('tutor-number').focus();

                        showAlert('Endere√ßo preenchido automaticamente!', 'success');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showAlert('Erro ao buscar CEP. Verifique sua conex√£o e tente novamente.', 'danger');
                } finally {
                    btnBuscarCep.innerHTML = originalBtnText;
                    btnBuscarCep.disabled = false;
                }
            }

            // Buscar CEP ao clicar no bot√£o
            document.getElementById('btn-buscar-cep').addEventListener('click', buscarCEP);

            // Buscar CEP ao sair do campo (blur)
            document.getElementById('tutor-cep').addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    buscarCEP();
                }
            });

            // Buscar CEP ao pressionar Enter
            document.getElementById('tutor-cep').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarCEP();
                }
            });

            // Submit do formul√°rio
            document.getElementById('petForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (currentStep === 1) {
                    nextStep();
                } else {
                    if (validateStep2()) {
                        confirmarAcao('Tem certeza que deseja cadastrar este pet?', () => {
                            submitForm(false);
                        });
                    }
                }
            });

            // Valida√ß√£o em tempo real
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('blur', () => {
                    if (field.hasAttribute('required') && !field.value.trim()) {
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                field.addEventListener('input', () => {
                    if (field.classList.contains('is-invalid') && field.value.trim()) {
                        field.classList.remove('is-invalid');
                    }
                });
            });
        });
    </script>
</body>
</html>
