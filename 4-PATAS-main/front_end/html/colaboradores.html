<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Associa√ß√£o 4 Patas - Gerenciamento de Colaboradores</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" type="text/css" href="../css/colaboradores.css"/>
    
</head>
<body>
    <!-- Decorative paws -->
    <div class="paws paw1">üêæ</div>
    <div class="paws paw2">üêæ</div>
    <div class="paws paw3">üêæ</div>

    <!-- Header -->
    <header class="main-header">
        <div class="main-container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">
                        <i class="fas fa-paw"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Gerenciamento de Colaboradores</h1>
                        <p class="header-subtitle">Associa√ß√£o 4 Patas</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-custom-secondary me-2" onclick="window.location.href='index.html';">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Menu
                    </button>
                    <button class="btn btn-custom-primary me-2" id="novo-colaborador">
                        <i class="fas fa-plus me-2"></i>
                        Novo Colaborador
                    </button>
                    <button class="btn btn-custom-secondary" id="exportar-pdf">
                        <i class="fas fa-download me-2"></i>
                        Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Alert -->
        <div id="alert" class="alert d-none mt-3" role="alert"></div>

        <!-- Search -->
        <div class="search-section">
            <div class="row">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="search-input" class="form-control search-input border-start-0" 
                               placeholder="Buscar colaborador por nome, fun√ß√£o, ID...">
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-custom-primary w-100" onclick="filterCollaborators()">
                        <i class="fas fa-search me-2"></i>
                        Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- DESKTOP VIEW: Table -->
        <div class="collaborators-container-desktop">
            <div class="collaborators-table">
                <div class="table-header">
                    <h3>
                        <i class="fas fa-users"></i>
                        Lista de Colaboradores
                    </h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Fun√ß√£o</th>
                                <th>CRMV</th>
                                <th>Data Cadastro</th>
                                <th>Status</th>
                                <th width="140">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="collaborators-table-body">
                            <!-- Dados ser√£o inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MOBILE VIEW: Cards -->
        <div class="collaborators-container-mobile">
            <div id="collaborators-cards-container">
                <!-- Cards ser√£o inseridos via JavaScript -->
            </div>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination" id="pagination-container">
                <!-- Pagina√ß√£o ser√° gerada dinamicamente -->
            </ul>
        </nav>
    </div>

    <!-- Modal Colaborador -->
    <div class="modal fade" id="collaboratorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Novo Colaborador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-colaborador" novalidate>
                        <input type="hidden" id="colaborador-id">
                        
                        <!-- Dados Pessoais -->
                        <div class="row mb-3">
                            <div class="col-md-8 mb-3">
                                <label for="nome" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                                <input type="text" id="nome" name="nome" class="form-control" required>
                                <div class="invalid-feedback">Nome √© obrigat√≥rio</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="funcao" class="form-label">Fun√ß√£o <span class="text-danger">*</span></label>
                                <select id="funcao" name="funcao" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    <option value="Veterin√°rio(a)">Veterin√°rio(a)</option>
                                    <option value="Auxiliar Veterin√°rio">Auxiliar Veterin√°rio</option>
                                    <option value="Recepcionista">Recepcionista</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Tosador(a)">Tosador(a)</option>
                                    <option value="Volunt√°rio">Volunt√°rio</option>
                                </select>
                                <div class="invalid-feedback">Fun√ß√£o √© obrigat√≥ria</div>
                            </div>
                        </div>

                        <!-- Contato -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="telefone" class="form-label">Telefone <span class="text-danger">*</span></label>
                                <input type="tel" id="telefone" name="telefone" class="form-control" 
                                       placeholder="(00) 00000-0000" required>
                                <div class="invalid-feedback">Telefone √© obrigat√≥rio</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">E-mail</label>
                                <input type="email" id="email" name="email" class="form-control" 
                                       placeholder="email@exemplo.com">
                            </div>
                        </div>

                        <!-- CRMV e Status -->
                        <div class="row mb-3">
                            <div class="col-md-2 mb-3" id="crmv-estado-container" style="display: none;">
                                <label for="crmv-estado" class="form-label">CRMV UF</label>
                                <select id="crmv-estado" name="crmvEstado" class="form-control">
                                    <option value="">UF</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                                <small class="text-muted">Estado</small>
                            </div>
                            <div class="col-md-4 mb-3" id="crmv-numero-container" style="display: none;">
                                <label for="crmv-numero" class="form-label">CRMV N√∫mero</label>
                                <input type="text" id="crmv-numero" name="crmvNumero" class="form-control"
                                       placeholder="Ex: 12345">
                                <small class="text-muted">Apenas para veterin√°rios</small>
                            </div>
                            <div class="mb-3" id="status-container">
                                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                <select id="status" name="status" class="form-control" required>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Inativo">Inativo</option>
                                </select>
                                <div class="invalid-feedback">Status √© obrigat√≥rio</div>
                            </div>
                        </div>

                        <!-- Data de Cadastro -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="data-cadastro" class="form-label">Data de Cadastro</label>
                                <input type="date" id="data-cadastro" name="dataCadastro" class="form-control" readonly>
                            </div>
                        </div>

                        <!-- Endere√ßo -->
                        <h6 class="mb-3 text-secondary">
                            <i class="fas fa-map-marker-alt me-2"></i>Endere√ßo
                        </h6>

                        <div class="row mb-3">
                            <div class="col-md-3 mb-3">
                                <label for="cep" class="form-label">CEP</label>
                                <div class="input-group">
                                    <input type="text" id="cep" name="cep" class="form-control"
                                           placeholder="00000-000">
                                    <button class="btn btn-outline-secondary" type="button" id="btn-buscar-cep" title="Buscar CEP">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="logradouro" class="form-label">Endere√ßo</label>
                                <input type="text" id="logradouro" name="logradouro" class="form-control"
                                       placeholder="Rua, Avenida...">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label for="numero" class="form-label">N√∫mero</label>
                                <input type="text" id="numero" name="numero" class="form-control"
                                       placeholder="N¬∫">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4 mb-3">
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" id="bairro" name="bairro" class="form-control"
                                       placeholder="Bairro">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" id="cidade" name="cidade" class="form-control"
                                       placeholder="Cidade">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select id="estado" name="estado" class="form-control">
                                    <option value="">Selecione o estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                            <textarea id="observacoes" name="observacoes" class="form-control" rows="3"
                                      placeholder="Informa√ß√µes adicionais sobre o colaborador"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-salvar">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclus√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p>Tem certeza que deseja excluir este colaborador?</p>
                    <p class="text-muted">Esta a√ß√£o n√£o pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">
                        <i class="fas fa-trash me-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API URL
        const API_URL = 'http://localhost:3000/api/colaboradores';

        // Array para armazenar dados carregados da API
        let collaboratorsData = [];
        let filteredCollaborators = [];

        // Pagina√ß√£o
        let currentPage = 1;
        const itemsPerPage = 10;

        // Elementos DOM
        const searchInput = document.getElementById('search-input');
        const alertBox = document.getElementById('alert');
        const collaboratorsTableBody = document.getElementById('collaborators-table-body');
        const collaboratorsCardsContainer = document.getElementById('collaborators-cards-container');
        const paginationContainer = document.getElementById('pagination-container');
        const collaboratorModal = new bootstrap.Modal(document.getElementById('collaboratorModal'));
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');

        let currentDeleteId = null;
        let editingId = null;

        // Carregar colaboradores da API
        async function loadCollaborators() {
            try {
                const response = await fetch(API_URL);
                if (response.ok) {
                    collaboratorsData = await response.json();
                    filteredCollaborators = collaboratorsData;
                    currentPage = 1;
                    renderCollaborators();
                    renderPagination();
                } else {
                    showAlert('Erro ao carregar colaboradores do servidor', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est√° rodando.', 'danger');
                collaboratorsData = [];
                filteredCollaborators = [];
            }
        }

        // Renderizar pagina√ß√£o
        function renderPagination() {
            const totalPages = Math.ceil(filteredCollaborators.length / itemsPerPage);
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            // Bot√£o anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderCollaborators();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(prevLi);

            // N√∫meros das p√°ginas
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderCollaborators();
                    renderPagination();
                });
                paginationContainer.appendChild(pageLi);
            }

            // Bot√£o pr√≥ximo
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCollaborators();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(nextLi);
        }

        // Formata√ß√£o da data
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Mostrar alerta
        function showAlert(message, type) {
            alertBox.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            `;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('d-none');

            setTimeout(() => {
                alertBox.classList.add('d-none');
            }, 4000);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Renderizar tabela (Desktop)
        function renderCollaboratorsTable(collaborators) {
            collaboratorsTableBody.innerHTML = '';

            if (collaborators.length === 0) {
                collaboratorsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Nenhum colaborador cadastrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Aplicar pagina√ß√£o
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCollaborators = collaborators.slice(startIndex, endIndex);

            paginatedCollaborators.forEach(collaborator => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${collaborator.IDCOLABORADOR}</strong></td>
                    <td>${collaborator.NOME || collaborator.nome}</td>
                    <td>${collaborator.CARGO || collaborator.funcao || '-'}</td>
                    <td>${collaborator.CRMV || collaborator.crmv || '-'}</td>
                    <td>${formatDate(collaborator.DATACAD || collaborator.dataCadastro)}</td>
                    <td>
                        <span class="status-badge status-${(collaborator.ATIVO === 'S' || collaborator.status === 'Ativo') ? 'ativo' : 'inativo'}">
                            ${collaborator.ATIVO === 'S' || collaborator.status === 'Ativo' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewCollaborator(${collaborator.IDCOLABORADOR})" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-edit" onclick="editCollaborator(${collaborator.IDCOLABORADOR})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="showDeleteConfirmation(${collaborator.IDCOLABORADOR})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                collaboratorsTableBody.appendChild(row);
            });
        }

        // Renderizar cards (Mobile)
        function renderCollaboratorsCards(collaborators) {
            collaboratorsCardsContainer.innerHTML = '';

            if (collaborators.length === 0) {
                collaboratorsCardsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nenhum colaborador cadastrado</p>
                    </div>
                `;
                return;
            }

            // Aplicar pagina√ß√£o
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCollaborators = collaborators.slice(startIndex, endIndex);

            paginatedCollaborators.forEach(collaborator => {
                const card = document.createElement('div');
                card.className = 'collaborator-card-mobile';
                card.innerHTML = `
                    <div class="collaborator-header-mobile">
                        <h4 class="collaborator-name-mobile">${collaborator.NOME || collaborator.nome}</h4>
                        <span class="status-badge status-${(collaborator.ATIVO === 'S' || collaborator.status === 'Ativo') ? 'ativo' : 'inativo'}">
                            ${collaborator.ATIVO === 'S' || collaborator.status === 'Ativo' ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>

                    <div class="collaborator-details-mobile">
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">ID</span>
                            <span class="collaborator-detail-value-mobile">${collaborator.IDCOLABORADOR}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">Fun√ß√£o</span>
                            <span class="collaborator-detail-value-mobile">${collaborator.CARGO || collaborator.funcao || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">CRMV</span>
                            <span class="collaborator-detail-value-mobile">${collaborator.CRMV || collaborator.crmv || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">Telefone</span>
                            <span class="collaborator-detail-value-mobile">${collaborator.TELEFONE || collaborator.telefone || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">E-mail</span>
                            <span class="collaborator-detail-value-mobile">${collaborator.EMAIL || collaborator.email || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">Data Cadastro</span>
                            <span class="collaborator-detail-value-mobile">${formatDate(collaborator.DATACAD || collaborator.dataCadastro)}</span>
                        </div>
                    </div>

                    <div class="collaborator-actions-mobile">
                        <button class="action-btn btn-view" onclick="viewCollaborator(${collaborator.IDCOLABORADOR})" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-edit" onclick="editCollaborator(${collaborator.IDCOLABORADOR})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="showDeleteConfirmation(${collaborator.IDCOLABORADOR})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                collaboratorsCardsContainer.appendChild(card);
            });
        }

        // Renderizar colaboradores (ambas as views)
        function renderCollaborators(collaborators = filteredCollaborators) {
            renderCollaboratorsTable(collaborators);
            renderCollaboratorsCards(collaborators);
        }

        // Filtrar colaboradores
        function filterCollaborators() {
            const searchTerm = searchInput.value.toLowerCase();

            if (!searchTerm) {
                filteredCollaborators = collaboratorsData;
                currentPage = 1;
                renderCollaborators();
                renderPagination();
                return;
            }

            filteredCollaborators = collaboratorsData.filter(collaborator => {
                const nome = collaborator.NOME || collaborator.nome || '';
                const funcao = collaborator.CARGO || collaborator.funcao || '';
                const crmv = collaborator.CRMV || collaborator.crmv || '';
                const id = (collaborator.IDCOLABORADOR || '').toString();

                return (
                    nome.toLowerCase().includes(searchTerm) ||
                    funcao.toLowerCase().includes(searchTerm) ||
                    id.includes(searchTerm) ||
                    crmv.toLowerCase().includes(searchTerm)
                );
            });

            currentPage = 1;
            renderCollaborators();
            renderPagination();

            if (filteredCollaborators.length === 0) {
                showAlert('Nenhum colaborador encontrado com os termos de busca informados.', 'warning');
            } else {
                showAlert(`${filteredCollaborators.length} colaborador(es) encontrado(s).`, 'success');
            }
        }

        // Abrir modal para novo colaborador
        function openNewCollaboratorModal() {
            document.getElementById('modal-title').textContent = 'Novo Colaborador';
            document.getElementById('form-colaborador').reset();
            document.getElementById('colaborador-id').value = '';
            
            // Definir data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-cadastro').value = today;
            
            // Habilitar todos os campos
            enableFormFields();
            
            editingId = null;
            collaboratorModal.show();
        }

        // Visualizar colaborador
        async function viewCollaborator(collaboratorId) {
            try {
                const response = await fetch(`${API_URL}/${collaboratorId}`);
                if (response.ok) {
                    const collaborator = await response.json();
                    document.getElementById('modal-title').textContent = 'Detalhes do Colaborador';
                    fillForm(collaborator);

                    // Desabilitar todos os campos para visualiza√ß√£o
                    disableFormFields();

                    collaboratorModal.show();
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar dados do colaborador.', 'danger');
            }
        }

        // Editar colaborador
        async function editCollaborator(collaboratorId) {
            try {
                const response = await fetch(`${API_URL}/${collaboratorId}`);
                if (response.ok) {
                    const collaborator = await response.json();
                    document.getElementById('modal-title').textContent = 'Editar Colaborador';
                    fillForm(collaborator);

                    // Habilitar campos exceto data de cadastro
                    enableFormFields();
                    document.getElementById('data-cadastro').readOnly = true;

                    editingId = collaboratorId;
                    collaboratorModal.show();
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar dados do colaborador.', 'danger');
            }
        }

        // Preencher formul√°rio
        function fillForm(collaborator) {
            document.getElementById('colaborador-id').value = collaborator.IDCOLABORADOR || collaborator.id;
            document.getElementById('nome').value = collaborator.NOME || collaborator.nome || '';
            document.getElementById('funcao').value = collaborator.CARGO || collaborator.funcao || '';

            // Atualizar visibilidade dos campos CRMV
            toggleCRMVFields();

            // Separar CRMV
            const crmv = collaborator.CRMV || collaborator.crmv || '';
            if (crmv) {
                const crmvMatch = crmv.match(/CRMV-([A-Z]{2})\s*(\d+)/);
                if (crmvMatch) {
                    document.getElementById('crmv-estado').value = crmvMatch[1];
                    document.getElementById('crmv-numero').value = crmvMatch[2];
                } else {
                    document.getElementById('crmv-estado').value = '';
                    document.getElementById('crmv-numero').value = crmv;
                }
            }

            document.getElementById('telefone').value = collaborator.TELEFONE || collaborator.telefone || '';
            document.getElementById('email').value = collaborator.EMAIL || collaborator.email || '';

            const ativo = collaborator.ATIVO === 'S' || collaborator.status === 'Ativo';
            document.getElementById('status').value = ativo ? 'Ativo' : 'Inativo';

            // Preencher endere√ßo
            document.getElementById('cep').value = collaborator.CEP || '';
            document.getElementById('logradouro').value = collaborator.LOGRADOURO || '';
            document.getElementById('numero').value = collaborator.NUMERO || '';
            document.getElementById('bairro').value = collaborator.BAIRRO || '';
            document.getElementById('cidade').value = collaborator.CIDADE || '';
            document.getElementById('estado').value = collaborator.ESTADO || '';

            document.getElementById('observacoes').value = collaborator.OBSERVACOES || collaborator.observacoes || '';

            const dataCad = collaborator.DATACAD || collaborator.dataCadastro;
            if (dataCad) {
                const date = new Date(dataCad);
                document.getElementById('data-cadastro').value = date.toISOString().split('T')[0];
            }
        }

        // Habilitar campos do formul√°rio
        function enableFormFields() {
            document.querySelectorAll('#form-colaborador input, #form-colaborador select, #form-colaborador textarea').forEach(field => {
                field.disabled = false;
            });
            document.getElementById('btn-salvar').style.display = 'inline-block';
        }

        // Desabilitar campos do formul√°rio
        function disableFormFields() {
            document.querySelectorAll('#form-colaborador input, #form-colaborador select, #form-colaborador textarea').forEach(field => {
                field.disabled = true;
            });
            document.getElementById('btn-salvar').style.display = 'none';
        }

        // Mostrar confirma√ß√£o de exclus√£o
        function showDeleteConfirmation(collaboratorId) {
            currentDeleteId = collaboratorId;
            confirmDeleteModal.show();
        }

        // Excluir colaborador
        async function deleteCollaborator(collaboratorId) {
            try {
                const response = await fetch(`${API_URL}/${collaboratorId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Colaborador exclu√≠do com sucesso!', 'success');
                    await loadCollaborators();
                } else {
                    const result = await response.json();
                    showAlert(result.message || 'Erro ao excluir colaborador', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor.', 'danger');
            }
        }

        // Salvar colaborador
        async function saveCollaborator() {
            const form = document.getElementById('form-colaborador');

            // Valida√ß√£o simples
            if (!validateForm(form)) {
                showAlert('Por favor, preencha todos os campos obrigat√≥rios.', 'danger');
                return;
            }

            const formData = new FormData(form);

            // Combinar CRMV estado + n√∫mero
            const crmvEstado = formData.get('crmvEstado');
            const crmvNumero = formData.get('crmvNumero');
            let crmv = null;
            if (crmvEstado && crmvNumero) {
                crmv = `CRMV-${crmvEstado} ${crmvNumero}`;
            } else if (crmvNumero) {
                crmv = crmvNumero;
            }

            const collaboratorData = {
                NOME: formData.get('nome'),
                CARGO: formData.get('funcao'),
                CRMV: crmv,
                TELEFONE: formData.get('telefone'),
                EMAIL: formData.get('email') || null,
                ATIVO: formData.get('status') === 'Ativo' ? 'S' : 'N',
                CEP: formData.get('cep') || null,
                LOGRADOURO: formData.get('logradouro') || null,
                NUMERO: formData.get('numero') || null,
                BAIRRO: formData.get('bairro') || null,
                CIDADE: formData.get('cidade') || null,
                ESTADO: formData.get('estado') || null,
                OBSERVACOES: formData.get('observacoes') || null,
                DATACAD: editingId ? undefined : new Date().toISOString()
            };

            // Remove DATACAD if editing
            if (editingId) {
                delete collaboratorData.DATACAD;
            }

            const btnSalvar = document.getElementById('btn-salvar');
            const originalText = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            btnSalvar.disabled = true;

            try {
                let response;
                if (editingId) {
                    // Atualizar
                    response = await fetch(`${API_URL}/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(collaboratorData)
                    });
                } else {
                    // Criar
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(collaboratorData)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showAlert(editingId ? 'Colaborador atualizado com sucesso!' : 'Colaborador cadastrado com sucesso!', 'success');
                    collaboratorModal.hide();
                    await loadCollaborators();
                    editingId = null;
                } else {
                    showAlert(result.message || 'Erro ao salvar colaborador', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor.', 'danger');
            } finally {
                btnSalvar.innerHTML = originalText;
                btnSalvar.disabled = false;
            }
        }

        // Validar formul√°rio
        function validateForm(form) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // Exportar PDF
        function exportToPDF() {
            showAlert('Funcionalidade de exporta√ß√£o para PDF acionada! Em breve ser√° implementada.', 'success');
        }

        // Event Listeners
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                filterCollaborators();
            }
        });

        document.getElementById('novo-colaborador').addEventListener('click', openNewCollaboratorModal);
        document.getElementById('btn-salvar').addEventListener('click', saveCollaborator);
        document.getElementById('exportar-pdf').addEventListener('click', exportToPDF);

        btnConfirmDelete.addEventListener('click', () => {
            if (currentDeleteId !== null) {
                deleteCollaborator(currentDeleteId);
                confirmDeleteModal.hide();
                currentDeleteId = null;
            }
        });

        // M√°scara para telefone
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else {
                value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            }
            e.target.value = value;
        });

        // M√°scara para CEP
        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d{0,3}).*/, '$1-$2');
            e.target.value = value;
        });

        // Fun√ß√£o para buscar CEP
        async function buscarCEP() {
            const cepInput = document.getElementById('cep');
            const cep = cepInput.value.replace(/\D/g, '');

            if (cep.length !== 8) {
                showAlert('CEP inv√°lido. Digite 8 d√≠gitos.', 'warning');
                return;
            }

            const btnBuscarCep = document.getElementById('btn-buscar-cep');
            const originalBtnText = btnBuscarCep.innerHTML;
            btnBuscarCep.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btnBuscarCep.disabled = true;

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    showAlert('CEP n√£o encontrado.', 'warning');
                } else {
                    document.getElementById('logradouro').value = data.logradouro || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.localidade || '';
                    document.getElementById('estado').value = data.uf || '';

                    // Focar no campo n√∫mero
                    document.getElementById('numero').focus();

                    showAlert('Endere√ßo preenchido automaticamente!', 'success');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao buscar CEP. Verifique sua conex√£o e tente novamente.', 'danger');
            } finally {
                btnBuscarCep.innerHTML = originalBtnText;
                btnBuscarCep.disabled = false;
            }
        }

        // Buscar CEP ao clicar no bot√£o
        document.getElementById('btn-buscar-cep').addEventListener('click', buscarCEP);

        // Buscar CEP ao sair do campo (blur)
        document.getElementById('cep').addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                buscarCEP();
            }
        });

        // Buscar CEP ao pressionar Enter
        document.getElementById('cep').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarCEP();
            }
        });

        // Mostrar/ocultar campos CRMV baseado na fun√ß√£o
        function toggleCRMVFields() {
            const funcaoSelect = document.getElementById('funcao');
            const crmvEstadoContainer = document.getElementById('crmv-estado-container');
            const crmvNumeroContainer = document.getElementById('crmv-numero-container');
            const statusContainer = document.getElementById('status-container');

            const isVeterinario = funcaoSelect.value === 'Veterin√°rio(a)';

            if (isVeterinario) {
                crmvEstadoContainer.style.display = 'block';
                crmvNumeroContainer.style.display = 'block';
                statusContainer.className = 'col-md-6 mb-3';
            } else {
                crmvEstadoContainer.style.display = 'none';
                crmvNumeroContainer.style.display = 'none';
                statusContainer.className = 'mb-3';
                // Limpar valores quando n√£o for veterin√°rio
                document.getElementById('crmv-estado').value = '';
                document.getElementById('crmv-numero').value = '';
            }
        }

        // Event listener para mudan√ßa de fun√ß√£o
        document.getElementById('funcao').addEventListener('change', toggleCRMVFields);

        // Inicializar
        loadCollaborators();
    </script>
</body>
</html>
