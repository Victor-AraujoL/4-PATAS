<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Vacinas - Associa칞칚o 4 Patas</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" type="text/css" href="../css/pesquisar_vacinas.css"/>
    
</head>
<body>
    <!-- Decorative paws -->
    <div class="paws paw1">游</div>
    <div class="paws paw2">游</div>
    <div class="paws paw3">游</div>

    <!-- Header -->
    <header class="main-header">
        <div class="main-container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Controle de Vacinas</h1>
                        <p class="header-subtitle">Associa칞칚o 4 Patas</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-custom-secondary me-2" onclick="window.location.href='index.html';">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Menu
                    </button>
                    <button class="btn btn-custom-primary me-2" onclick="openVaccineModal()">
                        <i class="fas fa-plus me-2"></i>
                        Nova Vacina
                    </button>
                    <button class="btn btn-custom-secondary" onclick="exportToPDF()">
                        <i class="fas fa-download me-2"></i>
                        Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Alert -->
        <div id="alert" class="alert d-none mt-3" role="alert"></div>

        <!-- Search -->
        <div class="search-section">
            <div class="row">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="search-input" class="form-control search-input border-start-0" 
                               placeholder="Buscar por nome da vacina, lote ou veterin치rio...">
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-custom-primary w-100" onclick="filterVaccines()">
                        <i class="fas fa-search me-2"></i>
                        Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- DESKTOP VIEW: Table -->
        <div class="vaccines-container-desktop">
            <div class="vaccines-table">
                <div class="table-header">
                    <h3>
                        <i class="fas fa-list"></i>
                        Lista de Vacinas Cadastradas
                    </h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Vacina</th>
                                <th>Lote</th>
                                <th>Marca</th>
                                <th>Fornecedor</th>
                                <th>Cadastro</th>
                                <th>Validade</th>
                                <th>Status</th>
                                <th width="120">A칞칫es</th>
                            </tr>
                        </thead>
                        <tbody id="vaccines-table-body">
                            <!-- Dados ser칚o inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MOBILE VIEW: Cards -->
        <div class="vaccines-container-mobile">
            <div id="vaccines-cards-container">
                <!-- Cards ser칚o inseridos via JavaScript -->
            </div>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">2</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#">3</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Modal Adicionar/Editar Vacina -->
    <div class="modal fade" id="vaccineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nova Vacina</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vaccine-form">
                        <input type="hidden" id="vaccine-id">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="vaccine-name" class="form-label">Nome da Vacina *</label>
                                <input type="text" class="form-control" id="vaccine-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vaccine-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="vaccine-batch">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vaccine-expiry" class="form-label">Data de Validade</label>
                                <input type="date" class="form-control" id="vaccine-expiry">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vaccine-brand" class="form-label">Marca</label>
                                <input type="text" class="form-control" id="vaccine-brand">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vaccine-supplier" class="form-label">Fornecedor</label>
                                <input type="text" class="form-control" id="vaccine-supplier">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="vaccine-status" class="form-label">Status *</label>
                                <select class="form-control" id="vaccine-status" required>
                                    <option value="S">Ativa</option>
                                    <option value="N">Inativa</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-custom-primary" id="btn-save">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirma칞칚o Exclus칚o -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclus칚o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p>Tem certeza que deseja excluir esta vacina?</p>
                    <p class="text-muted">Esta a칞칚o n칚o pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">
                        <i class="fas fa-trash me-2"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = 'http://localhost:3000/api/vacinas';
        let vaccinesData = [];

        // Elementos DOM
        const searchInput = document.getElementById('search-input');
        const alertBox = document.getElementById('alert');
        const vaccinesTableBody = document.getElementById('vaccines-table-body');
        const vaccinesCardsContainer = document.getElementById('vaccines-cards-container');
        const vaccineModal = new bootstrap.Modal(document.getElementById('vaccineModal'));
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const vaccineForm = document.getElementById('vaccine-form');
        const btnSave = document.getElementById('btn-save');
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');
        const modalTitle = document.getElementById('modalTitle');

        let currentDeleteId = null;
        let isEditing = false;

        // Carregar vacinas da API
        async function loadVaccines() {
            try {
                const response = await fetch(API_URL);
                if (response.ok) {
                    vaccinesData = await response.json();
                    renderVaccines();
                } else {
                    showAlert('Erro ao carregar vacinas do servidor', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est치 rodando.', 'danger');
                vaccinesData = [];
            }
        }

        // Formata칞칚o de data
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        // Verificar se a vacina est치 expirando
        function isExpiring(expiryDate) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 30 && diffDays > 0;
        }

        // Mostrar alerta
        function showAlert(message, type) {
            alertBox.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            `;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('d-none');
            
            setTimeout(() => {
                alertBox.classList.add('d-none');
            }, 4000);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Renderizar tabela (Desktop)
        function renderVaccinesTable(vaccines) {
            vaccinesTableBody.innerHTML = '';

            if (vaccines.length === 0) {
                vaccinesTableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h5>Nenhuma vacina encontrada</h5>
                                <p class="mb-0">Tente ajustar os termos de busca ou adicione uma nova vacina.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            vaccines.forEach(vaccine => {
                const expiring = vaccine.Data_validade ? isExpiring(vaccine.Data_validade) : false;
                let statusClass = vaccine.ATIVO === 'S' ? 'status-active' : 'status-inactive';
                let statusText = vaccine.ATIVO === 'S' ? 'Ativa' : 'Inativa';

                if (expiring && vaccine.ATIVO === 'S') {
                    statusClass = 'status-expiring';
                    statusText = 'Expirando';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${vaccine.NOME || '-'}</strong></td>
                    <td><span class="batch-code">${vaccine.Lote || '-'}</span></td>
                    <td>${vaccine.Marca || '-'}</td>
                    <td>${vaccine.Fornecedor || '-'}</td>
                    <td>${vaccine.DATACAD ? formatDate(vaccine.DATACAD) : '-'}</td>
                    <td>${vaccine.Data_validade ? formatDate(vaccine.Data_validade) : '-'}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editVaccine(${vaccine.IDVACINA})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="showDeleteConfirmation(${vaccine.IDVACINA})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                vaccinesTableBody.appendChild(row);
            });
        }

        // Renderizar cards (Mobile)
        function renderVaccinesCards(vaccines) {
            vaccinesCardsContainer.innerHTML = '';

            if (vaccines.length === 0) {
                vaccinesCardsContainer.innerHTML = `
                    <div class="vaccine-card-mobile">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h5>Nenhuma vacina encontrada</h5>
                            <p class="mb-0">Tente ajustar os termos de busca ou adicione uma nova vacina.</p>
                        </div>
                    </div>
                `;
                return;
            }

            vaccines.forEach(vaccine => {
                const expiring = vaccine.Data_validade ? isExpiring(vaccine.Data_validade) : false;
                let statusClass = vaccine.ATIVO === 'S' ? 'status-active' : 'status-inactive';
                let statusText = vaccine.ATIVO === 'S' ? 'Ativa' : 'Inativa';

                if (expiring && vaccine.ATIVO === 'S') {
                    statusClass = 'status-expiring';
                    statusText = 'Expirando';
                }

                const card = document.createElement('div');
                card.className = 'vaccine-card-mobile';
                card.innerHTML = `
                    <div class="vaccine-header-mobile">
                        <h4 class="vaccine-name-mobile">${vaccine.NOME || '-'}</h4>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </div>

                    <div class="vaccine-details-mobile">
                        <div class="vaccine-detail-mobile">
                            <span class="vaccine-detail-label-mobile">Lote</span>
                            <span class="vaccine-detail-value-mobile"><span class="batch-code">${vaccine.Lote || '-'}</span></span>
                        </div>
                        <div class="vaccine-detail-mobile">
                            <span class="vaccine-detail-label-mobile">Marca</span>
                            <span class="vaccine-detail-value-mobile">${vaccine.Marca || '-'}</span>
                        </div>
                        <div class="vaccine-detail-mobile">
                            <span class="vaccine-detail-label-mobile">Fornecedor</span>
                            <span class="vaccine-detail-value-mobile">${vaccine.Fornecedor || '-'}</span>
                        </div>
                        <div class="vaccine-detail-mobile">
                            <span class="vaccine-detail-label-mobile">Cadastro</span>
                            <span class="vaccine-detail-value-mobile">${vaccine.DATACAD ? formatDate(vaccine.DATACAD) : '-'}</span>
                        </div>
                        <div class="vaccine-detail-mobile">
                            <span class="vaccine-detail-label-mobile">Validade</span>
                            <span class="vaccine-detail-value-mobile">${vaccine.Data_validade ? formatDate(vaccine.Data_validade) : '-'}</span>
                        </div>
                    </div>

                    <div class="vaccine-actions-mobile">
                        <button class="action-btn btn-edit" onclick="editVaccine(${vaccine.IDVACINA})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="showDeleteConfirmation(${vaccine.IDVACINA})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                vaccinesCardsContainer.appendChild(card);
            });
        }

        // Renderizar vacinas (ambas as views)
        function renderVaccines(vaccines = vaccinesData) {
            renderVaccinesTable(vaccines);
            renderVaccinesCards(vaccines);
        }

        // Filtrar vacinas
        function filterVaccines() {
            const searchTerm = searchInput.value.toLowerCase();

            if (!searchTerm) {
                renderVaccines();
                return;
            }

            const filteredVaccines = vaccinesData.filter(vaccine => {
                return (
                    (vaccine.NOME && vaccine.NOME.toLowerCase().includes(searchTerm)) ||
                    (vaccine.Lote && vaccine.Lote.toLowerCase().includes(searchTerm)) ||
                    (vaccine.Marca && vaccine.Marca.toLowerCase().includes(searchTerm)) ||
                    (vaccine.Fornecedor && vaccine.Fornecedor.toLowerCase().includes(searchTerm))
                );
            });

            renderVaccines(filteredVaccines);

            if (filteredVaccines.length === 0) {
                showAlert('Nenhuma vacina encontrada com os termos de busca informados.', 'warning');
            } else {
                showAlert(`${filteredVaccines.length} vacina(s) encontrada(s).`, 'success');
            }
        }

        // Abrir modal de vacina
        function openVaccineModal() {
            isEditing = false;
            modalTitle.textContent = 'Nova Vacina';
            vaccineForm.reset();
            document.getElementById('vaccine-id').value = '';
            vaccineModal.show();
        }

        // Editar vacina
        async function editVaccine(vaccineId) {
            try {
                const response = await fetch(`${API_URL}/${vaccineId}`);
                if (response.ok) {
                    const vaccine = await response.json();
                    isEditing = true;
                    modalTitle.textContent = 'Editar Vacina';
                    document.getElementById('vaccine-id').value = vaccine.IDVACINA;
                    document.getElementById('vaccine-name').value = vaccine.NOME || '';
                    document.getElementById('vaccine-batch').value = vaccine.Lote || '';
                    document.getElementById('vaccine-expiry').value = vaccine.Data_validade ? vaccine.Data_validade.split('T')[0] : '';
                    document.getElementById('vaccine-brand').value = vaccine.Marca || '';
                    document.getElementById('vaccine-supplier').value = vaccine.Fornecedor || '';
                    document.getElementById('vaccine-status').value = vaccine.ATIVO || 'S';
                    vaccineModal.show();
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar dados da vacina.', 'danger');
            }
        }

        // Mostrar confirma칞칚o de exclus칚o
        function showDeleteConfirmation(vaccineId) {
            currentDeleteId = vaccineId;
            confirmDeleteModal.show();
        }

        // Excluir vacina
        async function deleteVaccine(vaccineId) {
            try {
                const response = await fetch(`${API_URL}/${vaccineId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Vacina exclu칤da com sucesso!', 'success');
                    await loadVaccines();
                } else {
                    const result = await response.json();
                    showAlert(result.message || 'Erro ao excluir vacina', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor.', 'danger');
            }
        }

        // Exportar para PDF
        function exportToPDF() {
            showAlert('Funcionalidade de exporta칞칚o para PDF acionada! Em breve ser치 implementada.', 'success');
        }

        // Event Listeners
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                filterVaccines();
            }
        });

        // Salvar vacina
        btnSave.addEventListener('click', async () => {
            // Validar campo obrigat칩rio
            const name = document.getElementById('vaccine-name').value.trim();

            if (!name) {
                document.getElementById('vaccine-name').classList.add('is-invalid');
                showAlert('Por favor, preencha o nome da vacina.', 'danger');
                return;
            }

            document.getElementById('vaccine-name').classList.remove('is-invalid');

            // Coletar dados
            const vaccineData = {
                NOME: name,
                Lote: document.getElementById('vaccine-batch').value.trim() || null,
                Data_validade: document.getElementById('vaccine-expiry').value || null,
                Marca: document.getElementById('vaccine-brand').value.trim() || null,
                Fornecedor: document.getElementById('vaccine-supplier').value.trim() || null,
                ATIVO: document.getElementById('vaccine-status').value,
                DATACAD: new Date().toISOString()
            };

            // Loading
            const originalText = btnSave.innerHTML;
            btnSave.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            btnSave.disabled = true;

            try {
                const id = document.getElementById('vaccine-id').value;
                let response;

                if (id) {
                    // Editar
                    response = await fetch(`${API_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(vaccineData)
                    });
                } else {
                    // Criar
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(vaccineData)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showAlert(id ? 'Vacina atualizada com sucesso!' : 'Vacina criada com sucesso!', 'success');
                    vaccineModal.hide();
                    await loadVaccines();
                } else {
                    showAlert(result.message || 'Erro ao salvar vacina', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor.', 'danger');
            } finally {
                btnSave.innerHTML = originalText;
                btnSave.disabled = false;
            }
        });

        btnConfirmDelete.addEventListener('click', () => {
            if (currentDeleteId !== null) {
                deleteVaccine(currentDeleteId);
                confirmDeleteModal.hide();
                currentDeleteId = null;
            }
        });

        // Carregar vacinas ao iniciar a p치gina
        loadVaccines();
    </script>
</body>
</html>
