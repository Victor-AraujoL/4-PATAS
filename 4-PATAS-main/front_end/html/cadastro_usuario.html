<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usu√°rios - Associa√ß√£o 4 Patas</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../css/colaboradores.css"/>

</head>
<body>
    <!-- Decorative paws -->
    <div class="paws paw1">üêæ</div>
    <div class="paws paw2">üêæ</div>
    <div class="paws paw3">üêæ</div>

    <!-- Header -->
    <header class="main-header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Gerenciamento de Usu√°rios</h1>
                        <p class="header-subtitle">Associa√ß√£o 4 Patas</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-custom-secondary" onclick="window.location.href='index.html';">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Menu
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid main-container mt-4">
        <!-- Alert -->
        <div id="alert" class="alert d-none mb-3" role="alert"></div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control search-input" id="search-input"
                               placeholder="Buscar por nome, e-mail, CPF ou ID...">
                    </div>
                </div>
                <div class="col-md-4 text-end mt-3 mt-md-0">
                    <button class="btn btn-custom-primary" id="novo-usuario">
                        <i class="fas fa-user-plus me-2"></i>
                        Novo Usu√°rio
                    </button>
                </div>
            </div>
        </div>

        <!-- Desktop Table View -->
        <div class="collaborators-container-desktop">
            <div class="collaborators-table">
                <div class="table-header">
                    <h3>
                        <i class="fas fa-users me-2"></i>
                        Usu√°rios do Sistema
                    </h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th width="80">ID</th>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Telefone</th>
                                <th>CPF</th>
                                <th width="120">Tipo</th>
                                <th width="150" class="text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-table-body">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                    <p>Carregando usu√°rios...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mobile Cards View -->
        <div class="collaborators-container-mobile">
            <div id="usuarios-cards-container">
                <!-- Cards ser√£o inseridos via JavaScript -->
            </div>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination" id="pagination-container">
                <!-- Pagina√ß√£o ser√° gerada dinamicamente -->
            </ul>
        </nav>
    </div>

    <!-- Modal Usu√°rio -->
    <div class="modal fade" id="usuarioModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Novo Usu√°rio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="usuarioForm" novalidate>
                        <input type="hidden" id="usuario-id">

                        <!-- Nome Completo -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nome" name="nome"
                                       placeholder="Nome" required>
                                <div class="invalid-feedback">Nome √© obrigat√≥rio</div>
                            </div>
                            <div class="col-md-6">
                                <label for="sobrenome" class="form-label">Sobrenome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="sobrenome" name="sobrenome"
                                       placeholder="Sobrenome" required>
                                <div class="invalid-feedback">Sobrenome √© obrigat√≥rio</div>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="seu@email.com" required>
                            <div class="invalid-feedback">E-mail v√°lido √© obrigat√≥rio</div>
                        </div>

                        <!-- Senhas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="senha" class="form-label">Senha <span class="text-danger" id="senha-required">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="senha" name="senha"
                                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                                    <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                    </button>
                                </div>
                                <small class="text-muted" id="senha-hint">M√≠nimo 6 caracteres</small>
                                <div class="invalid-feedback">Senha deve ter pelo menos 6 caracteres</div>
                            </div>
                            <div class="col-md-6">
                                <label for="confirmarSenha" class="form-label">Confirmar Senha <span class="text-danger" id="confirmar-required">*</span></label>
                                <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                                <div class="invalid-feedback">Senhas n√£o coincidem</div>
                            </div>
                        </div>

                        <!-- Telefone e CPF -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" name="telefone"
                                       placeholder="(00) 00000-0000">
                                <div class="invalid-feedback">Formato inv√°lido</div>
                            </div>
                            <div class="col-md-6">
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" class="form-control" id="cpf" name="cpf"
                                       placeholder="000.000.000-00">
                                <div class="invalid-feedback">Formato inv√°lido</div>
                            </div>
                        </div>

                        <!-- Admin -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="admin" name="admin">
                                <label class="form-check-label" for="admin">
                                    <strong>Administrador</strong>
                                    <small class="text-muted d-block">Usu√°rios administradores t√™m acesso completo ao sistema</small>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-salvar">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirma√ß√£o Delete -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirmar Exclus√£o
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">
                        <i class="fas fa-trash me-2"></i>Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API URL - Detecta automaticamente a origem
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : `${window.location.origin}/api`;
        const API_URL = `${API_BASE}/usuarios`;

        // Array para armazenar dados carregados da API
        let usuariosData = [];
        let filteredUsuarios = [];

        // Pagina√ß√£o
        let currentPage = 1;
        const itemsPerPage = 10;

        // Elementos DOM
        const searchInput = document.getElementById('search-input');
        const alertBox = document.getElementById('alert');
        const usuariosTableBody = document.getElementById('usuarios-table-body');
        const usuariosCardsContainer = document.getElementById('usuarios-cards-container');
        const paginationContainer = document.getElementById('pagination-container');
        const usuarioModal = new bootstrap.Modal(document.getElementById('usuarioModal'));
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');
        const btnSalvar = document.getElementById('btn-salvar');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const togglePasswordIcon = document.getElementById('togglePasswordIcon');
        const senhaInput = document.getElementById('senha');
        const confirmarSenhaInput = document.getElementById('confirmarSenha');

        let currentDeleteId = null;
        let editingId = null;

        // ========== SISTEMA DE ALERTAS ==========
        function showAlert(message, type = 'success') {
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle'
            };

            alertBox.innerHTML = `
                <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
                ${message}
            `;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('d-none');

            setTimeout(() => {
                alertBox.classList.add('d-none');
            }, 5000);
        }

        function hideAlert() {
            alertBox.classList.add('d-none');
        }

        // ========== TOGGLE PASSWORD VISIBILITY ==========
        togglePasswordBtn.addEventListener('click', () => {
            const type = senhaInput.type === 'password' ? 'text' : 'password';
            senhaInput.type = type;
            confirmarSenhaInput.type = type;

            togglePasswordIcon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        });

        // ========== CARREGAR USU√ÅRIOS ==========
        async function loadUsuarios() {
            try {
                const response = await fetch(API_URL);
                if (response.ok) {
                    usuariosData = await response.json();
                    filteredUsuarios = usuariosData;
                    currentPage = 1;
                    renderUsuarios();
                    renderPagination();
                } else {
                    showAlert('Erro ao carregar usu√°rios do servidor', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est√° rodando.', 'danger');
                usuariosData = [];
                filteredUsuarios = [];
            }
        }

        // ========== PAGINA√á√ÉO ==========
        function renderPagination() {
            const totalPages = Math.ceil(filteredUsuarios.length / itemsPerPage);
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            // Bot√£o anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderUsuarios();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(prevLi);

            // N√∫meros das p√°ginas
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderUsuarios();
                    renderPagination();
                });
                paginationContainer.appendChild(pageLi);
            }

            // Bot√£o pr√≥ximo
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderUsuarios();
                    renderPagination();
                }
            });
            paginationContainer.appendChild(nextLi);
        }

        // ========== RENDERIZAR TABELA ==========
        function renderUsuariosTable(usuarios = filteredUsuarios) {
            usuariosTableBody.innerHTML = '';

            if (usuarios.length === 0) {
                usuariosTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Nenhum usu√°rio cadastrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Aplicar pagina√ß√£o
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsuarios = usuarios.slice(startIndex, endIndex);

            paginatedUsuarios.forEach(usuario => {
                const row = document.createElement('tr');
                const isAdmin = usuario.ADMIN === 'S' || usuario.admin === 'S';

                row.innerHTML = `
                    <td><strong>#${usuario.IDUSUARIO || usuario.id}</strong></td>
                    <td>${usuario.NOME || usuario.nome || '-'}</td>
                    <td><small>${usuario.EMAIL || usuario.email || '-'}</small></td>
                    <td>${usuario.TELEFONE || usuario.telefone || '-'}</td>
                    <td>${usuario.CPF || usuario.cpf || '-'}</td>
                    <td>
                        <span class="status-badge ${isAdmin ? 'status-inativo' : 'status-ativo'}">
                            <i class="fas fa-${isAdmin ? 'user-shield' : 'user'}"></i>
                            ${isAdmin ? 'Admin' : 'Usu√°rio'}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="action-btn btn-edit" onclick="editarUsuario(${usuario.IDUSUARIO || usuario.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="confirmarExclusao(${usuario.IDUSUARIO || usuario.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                usuariosTableBody.appendChild(row);
            });
        }

        // ========== RENDERIZAR CARDS (MOBILE) ==========
        function renderUsuariosCards(usuarios = filteredUsuarios) {
            usuariosCardsContainer.innerHTML = '';

            if (usuarios.length === 0) {
                usuariosCardsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nenhum usu√°rio cadastrado</p>
                    </div>
                `;
                return;
            }

            // Aplicar pagina√ß√£o
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsuarios = usuarios.slice(startIndex, endIndex);

            paginatedUsuarios.forEach(usuario => {
                const card = document.createElement('div');
                card.className = 'collaborator-card-mobile';
                const isAdmin = usuario.ADMIN === 'S' || usuario.admin === 'S';

                card.innerHTML = `
                    <div class="collaborator-header-mobile">
                        <h4 class="collaborator-name-mobile">${usuario.NOME || usuario.nome}</h4>
                        <span class="status-badge ${isAdmin ? 'status-inativo' : 'status-ativo'}">
                            ${isAdmin ? 'Admin' : 'Usu√°rio'}
                        </span>
                    </div>
                    <div class="collaborator-details-mobile">
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">ID</span>
                            <span class="collaborator-detail-value-mobile">#${usuario.IDUSUARIO || usuario.id}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">E-mail</span>
                            <span class="collaborator-detail-value-mobile">${usuario.EMAIL || usuario.email || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">Telefone</span>
                            <span class="collaborator-detail-value-mobile">${usuario.TELEFONE || usuario.telefone || '-'}</span>
                        </div>
                        <div class="collaborator-detail-mobile">
                            <span class="collaborator-detail-label-mobile">CPF</span>
                            <span class="collaborator-detail-value-mobile">${usuario.CPF || usuario.cpf || '-'}</span>
                        </div>
                    </div>
                    <div class="collaborator-actions-mobile">
                        <button class="action-btn btn-edit" onclick="editarUsuario(${usuario.IDUSUARIO || usuario.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="confirmarExclusao(${usuario.IDUSUARIO || usuario.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                usuariosCardsContainer.appendChild(card);
            });
        }

        // ========== RENDERIZAR USUARIOS (AMBAS AS VIEWS) ==========
        function renderUsuarios(usuarios = filteredUsuarios) {
            renderUsuariosTable(usuarios);
            renderUsuariosCards(usuarios);
        }

        // ========== FILTRAR USU√ÅRIOS ==========
        function filterUsuarios() {
            const searchTerm = searchInput.value.toLowerCase();

            if (!searchTerm) {
                filteredUsuarios = usuariosData;
                currentPage = 1;
                renderUsuarios();
                renderPagination();
                return;
            }

            filteredUsuarios = usuariosData.filter(usuario => {
                const nome = usuario.NOME || usuario.nome || '';
                const email = usuario.EMAIL || usuario.email || '';
                const cpf = usuario.CPF || usuario.cpf || '';
                const id = (usuario.IDUSUARIO || '').toString();

                return (
                    nome.toLowerCase().includes(searchTerm) ||
                    email.toLowerCase().includes(searchTerm) ||
                    cpf.toLowerCase().includes(searchTerm) ||
                    id.includes(searchTerm)
                );
            });

            currentPage = 1;
            renderUsuarios();
            renderPagination();

            if (filteredUsuarios.length === 0) {
                showAlert('Nenhum usu√°rio encontrado com os termos de busca informados.', 'warning');
            } else {
                showAlert(`${filteredUsuarios.length} usu√°rio(s) encontrado(s).`, 'success');
            }
        }

        // Event listener para busca
        searchInput.addEventListener('input', filterUsuarios);

        // ========== ABRIR MODAL NOVO USU√ÅRIO ==========
        function openNewUserModal() {
            document.getElementById('modal-title').textContent = 'Novo Usu√°rio';
            document.getElementById('usuarioForm').reset();
            document.getElementById('usuario-id').value = '';
            document.getElementById('admin').checked = false;

            // Senha obrigat√≥ria para novo usu√°rio
            senhaInput.required = true;
            confirmarSenhaInput.required = true;
            document.getElementById('senha-required').style.display = 'inline';
            document.getElementById('confirmar-required').style.display = 'inline';
            document.getElementById('senha-hint').textContent = 'M√≠nimo 6 caracteres';

            // Remover valida√ß√µes
            document.querySelectorAll('.is-valid, .is-invalid').forEach(field => {
                field.classList.remove('is-valid', 'is-invalid');
            });

            editingId = null;
            usuarioModal.show();
        }

        // ========== EDITAR USU√ÅRIO ==========
        async function editarUsuario(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (response.ok) {
                    const usuario = await response.json();

                    document.getElementById('modal-title').textContent = 'Editar Usu√°rio';
                    document.getElementById('usuario-id').value = usuario.IDUSUARIO || usuario.id;

                    // Separar nome e sobrenome
                    const nomeCompleto = (usuario.NOME || usuario.nome || '').split(' ');
                    document.getElementById('nome').value = nomeCompleto[0] || '';
                    document.getElementById('sobrenome').value = nomeCompleto.slice(1).join(' ') || '';

                    document.getElementById('email').value = usuario.EMAIL || usuario.email || '';
                    document.getElementById('telefone').value = usuario.TELEFONE || usuario.telefone || '';
                    document.getElementById('cpf').value = usuario.CPF || usuario.cpf || '';

                    const isAdmin = usuario.ADMIN === 'S' || usuario.admin === 'S';
                    document.getElementById('admin').checked = isAdmin;

                    // Senha opcional na edi√ß√£o
                    senhaInput.value = '';
                    confirmarSenhaInput.value = '';
                    senhaInput.required = false;
                    confirmarSenhaInput.required = false;
                    document.getElementById('senha-required').style.display = 'none';
                    document.getElementById('confirmar-required').style.display = 'none';
                    document.getElementById('senha-hint').textContent = 'Deixe em branco para manter a senha atual';

                    // Remover valida√ß√µes
                    document.querySelectorAll('.is-valid, .is-invalid').forEach(field => {
                        field.classList.remove('is-valid', 'is-invalid');
                    });

                    editingId = id;
                    usuarioModal.show();
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar dados do usu√°rio.', 'danger');
            }
        }

        // ========== SALVAR USU√ÅRIO ==========
        async function saveUsuario() {
            hideAlert();

            const formData = {
                nome: document.getElementById('nome').value.trim(),
                sobrenome: document.getElementById('sobrenome').value.trim(),
                email: document.getElementById('email').value.trim(),
                senha: senhaInput.value,
                confirmarSenha: confirmarSenhaInput.value,
                telefone: document.getElementById('telefone').value,
                cpf: document.getElementById('cpf').value,
                admin: document.getElementById('admin').checked
            };

            // Valida√ß√£o
            if (!validateForm(formData)) {
                return;
            }

            // Mostrar loading
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            btnSalvar.disabled = true;

            try {
                const userData = {
                    NOME: `${formData.nome} ${formData.sobrenome}`,
                    EMAIL: formData.email,
                    TELEFONE: formData.telefone || null,
                    CPF: formData.cpf || null,
                    ADMIN: formData.admin ? 'S' : 'N'
                };

                // Apenas incluir senha se foi preenchida
                if (formData.senha) {
                    userData.SENHA = formData.senha;
                }

                const url = editingId ? `${API_URL}/${editingId}` : API_URL;
                const method = editingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(editingId ? 'Usu√°rio atualizado com sucesso!' : 'Usu√°rio cadastrado com sucesso!', 'success');

                    // Fechar modal
                    usuarioModal.hide();

                    // Recarregar lista
                    await loadUsuarios();

                    editingId = null;
                } else {
                    showAlert(result.message || 'Erro ao salvar usu√°rio.', 'danger');
                }

            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor. Verifique se o backend est√° rodando.', 'danger');
            } finally {
                btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar';
                btnSalvar.disabled = false;
            }
        }

        // ========== VALIDA√á√ÉO DO FORM ==========
        function validateForm(data) {
            let isValid = true;

            // Validar nome
            if (!data.nome || data.nome.length < 2) {
                document.getElementById('nome').classList.add('is-invalid');
                isValid = false;
            }

            // Validar sobrenome
            if (!data.sobrenome || data.sobrenome.length < 2) {
                document.getElementById('sobrenome').classList.add('is-invalid');
                isValid = false;
            }

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!data.email || !emailRegex.test(data.email)) {
                document.getElementById('email').classList.add('is-invalid');
                isValid = false;
            }

            // Validar senha (apenas se for novo usu√°rio ou se foi preenchida na edi√ß√£o)
            if (!editingId || data.senha) {
                if (!data.senha || data.senha.length < 6) {
                    senhaInput.classList.add('is-invalid');
                    isValid = false;
                }

                if (data.senha !== data.confirmarSenha) {
                    confirmarSenhaInput.classList.add('is-invalid');
                    isValid = false;
                }
            }

            if (!isValid) {
                showAlert('Por favor, corrija os erros no formul√°rio.', 'danger');
            }

            return isValid;
        }

        // ========== CONFIRMAR EXCLUS√ÉO ==========
        function confirmarExclusao(id) {
            currentDeleteId = id;
            confirmDeleteModal.show();
        }

        // ========== EXCLUIR USU√ÅRIO ==========
        async function excluirUsuario() {
            if (!currentDeleteId) return;

            try {
                const response = await fetch(`${API_URL}/${currentDeleteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Usu√°rio exclu√≠do com sucesso!', 'success');
                    confirmDeleteModal.hide();
                    await loadUsuarios();
                } else {
                    const result = await response.json();
                    showAlert(result.message || 'Erro ao excluir usu√°rio', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao conectar com o servidor.', 'danger');
            }

            currentDeleteId = null;
        }

        // ========== M√ÅSCARAS ==========
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else {
                value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            }
            e.target.value = value;
        });

        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
            e.target.value = value;
        });

        // ========== EVENT LISTENERS ==========
        document.getElementById('novo-usuario').addEventListener('click', openNewUserModal);
        btnSalvar.addEventListener('click', saveUsuario);
        btnConfirmDelete.addEventListener('click', excluirUsuario);

        // Remover valida√ß√µes ao digitar
        ['nome', 'sobrenome', 'email', 'senha', 'confirmarSenha'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadUsuarios();
            console.log('P√°gina de gerenciamento de usu√°rios carregada com sucesso');
        });
    </script>
</body>
</html>
